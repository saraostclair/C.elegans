---
title: "Analysis"
format: html
---

```{r}
#loading in data
rm(list = ls())
library(readr)
library(broom)
library(knitr)
library(kableExtra)
# Load necessary libraries
library(tidyverse)  # for data handling
library(emmeans)    # for post-hoc tests (optional)
celegans_data_final <- readr::read_csv("data/dataset_final/celegans_data_final.csv")

# Convert 'age' and 'treatment' to factors with correct levels
celegans_data_final <- celegans_data_final %>%
  mutate(
    age = factor(age, levels = c("L4+1", "L4+7", "L4+14")),
    treatment = factor(treatment, levels = c("control", "mannitol"))
  )
# Ensure 'age' is a factor in the desired order
celegans_data_final$age <- factor(celegans_data_final$age, levels = c("L4+1", "L4+7", "L4+14"))
```

```{r}
# Create summary statistics table
summary_stats <- celegans_data_final %>%
  group_by(treatment, age) %>%
  summarise(
    mean_num    = mean(norm_aggr_num,  na.rm = TRUE),
    se_num      = sd(norm_aggr_num,    na.rm = TRUE) / sqrt(n()),
    mean_area   = mean(norm_aggr_area, na.rm = TRUE),
    se_area     = sd(norm_aggr_area,   na.rm = TRUE) / sqrt(n()),
    mean_intden = mean(norm_IntDen,    na.rm = TRUE),
    se_intden   = sd(norm_IntDen,      na.rm = TRUE) / sqrt(n()),
    .groups     = "drop"
  )

```


```{r}
# Run the two-way ANOVAs

# Aggregate number
anova_num <- aov(norm_aggr_num ~ age * treatment, data = celegans_data_final)
summary(anova_num)

# Aggregate area
anova_area <- aov(norm_aggr_area ~ age * treatment, data = celegans_data_final)
summary(anova_area)

# Fluorescence intensity
anova_intden <- aov(norm_IntDen ~ age * treatment, data = celegans_data_final)
summary(anova_intden)


# Tidy summaries
tidy_num <- tidy(anova_num)
tidy_area <- tidy(anova_area)
tidy_intden <- tidy(anova_intden)

# Function to print nice table
print_anova_table <- function(tidy_df, dv_name) {
  tidy_df %>%
    select(term, df = df, sumsq = statistic, meansq = statistic, statistic = statistic, p.value) %>%
    mutate_if(is.numeric, ~round(., 5)) %>%
    kable(caption = paste("ANOVA Table for", dv_name), col.names = c("Term", "Df", "Sum Sq", "Mean Sq", "F value", "Pr(>F)")) %>%
    kable_styling(full_width = FALSE)
}

# Print tables
print_anova_table(tidy_num, "Normalized Aggregate Number")
print_anova_table(tidy_area, "Normalized Aggregate Area")
print_anova_table(tidy_intden, "Normalized Fluorescence Intensity")
```

```{r}
# post hoc comparison 
# Function to format and display emmeans contrast table
print_emm_table <- function(contrast_obj, title) {
  contrast_df <- as.data.frame(contrast_obj)
  contrast_df <- contrast_df %>%
    mutate_if(is.numeric, ~round(., 4))  # Round numeric columns
  kable(contrast_df, caption = title) %>%
    kable_styling(full_width = FALSE)
}

# AGGREGATE NUMBER
emm_num <- emmeans(anova_num, pairwise ~ age | treatment)
print_emm_table(emm_num$contrasts, "Post Hoc: Age Comparisons within Each Treatment (Aggregate Number)")

emm_num_treat <- emmeans(anova_num, pairwise ~ treatment | age)
print_emm_table(emm_num_treat$contrasts, "Post Hoc: Treatment Comparisons within Each Age Group (Aggregate Number)")

# AGGREGATE AREA
emm_area <- emmeans(anova_area, pairwise ~ age | treatment)
print_emm_table(emm_area$contrasts, "Post Hoc: Age Comparisons within Each Treatment (Aggregate Area)")

emm_area_treat <- emmeans(anova_area, pairwise ~ treatment | age)
print_emm_table(emm_area_treat$contrasts, "Post Hoc: Treatment Comparisons within Each Age Group (Aggregate Area)")

# FLUORESCENCE INTENSITY
emm_intden <- emmeans(anova_intden, pairwise ~ age | treatment)
print_emm_table(emm_intden$contrasts, "Post Hoc: Age Comparisons within Each Treatment (Fluorescence Intensity)")

emm_intden_treat <- emmeans(anova_intden, pairwise ~ treatment | age)
print_emm_table(emm_intden_treat$contrasts, "Post Hoc: Treatment Comparisons within Each Age Group (Fluorescence Intensity)")

```

```{r}
#interaction plots 

plot_interaction_bar <- function(data, y, se, ylab, title) {
  ggplot(data, aes(x = age, y = !!sym(y), fill = treatment)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    geom_errorbar(aes(ymin = !!sym(y) - !!sym(se), ymax = !!sym(y) + !!sym(se)),
                  width = 0.2, position = position_dodge(width = 0.8)) +
    labs(x = "Age", y = ylab, fill = "Treatment", title = title) +
    theme_minimal(base_size = 14)
}

# Plot bar graphs:

# Aggregate Number
plot_interaction_bar(summary_stats, "mean_num", "se_num", "Normalized Aggregate Number", "Aggregate Number by Age and Treatment")

# Aggregate Area
plot_interaction_bar(summary_stats, "mean_area", "se_area", "Normalized Aggregate Area", "Aggregate Area by Age and Treatment")

# Fluorescence Intensity
plot_interaction_bar(summary_stats, "mean_intden", "se_intden", "Normalized Fluorescence Intensity", "Fluorescence Intensity by Age and Treatment")

```

